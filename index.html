<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>منصة التحدي 2025-2026</title>

<style>
body{
  font-family:Cairo,sans-serif;
  direction:rtl;
  margin:0;
  background:#000;
  color:white;
}
.page{display:none}
.section{
  margin:15px;
  padding:15px;
  border-radius:16px;
  background:rgba(255,255,255,.2);
}
input,button{
  width:100%;
  padding:10px;
  margin-top:8px;
  border-radius:10px;
  border:none;
  font-size:16px;
}
.table-input{
  background:white;
  color:#003f7d;
}
.logout-btn{background:#e53935;color:white}
.save-btn{background:#ffeb3b}
.teacher-grade-input{
  width:70px;
  text-align:center;
}
.teacher-grade-static{
  font-weight:bold;
  color:#ffeb3b;
}
</style>
</head>

<body>

<div class="section" id="loginBox">
  <input id="studentCode" placeholder="أدخل كود الطالب أو إيميل الأستاذ">
  <button onclick="searchStudent()">تسجيل الدخول</button>
  <div id="output"></div>
</div>

<div id="profilePage" class="page section"></div>
<div id="gradesPage" class="page section"></div>
<div id="teacherClassesPage" class="page section"></div>
<div id="teacherGradesPage" class="page section"></div>

<script>
/* =======================
   API
======================= */
const API_URL="https://script.google.com/macros/s/AKfycbx9v4mQRU4H6hzKoW2R7sYq_gwvmhVB3PdKeRsvhCGEkAVcOjxrtMJNzEIIGklZryt2/exec";

let currentStudent=null;
let currentTeacher=null;
let currentTeacherSubject="";
let currentTeacherClassName="";

/* =======================
   أدوات عامة
======================= */
function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.style.display="none");
  document.getElementById(id).style.display="block";
}

/* اسم الأم: حروف فقط */
function onlyArabicLetters(input){
  input.value=input.value.replace(/[^ء-ي\s]/g,"");
}

/* =======================
   تسجيل الدخول
======================= */
async function searchStudent(){
  const code=document.getElementById("studentCode").value.trim();
  if(!code)return;

  const res=await fetch(`${API_URL}?code=${encodeURIComponent(code)}`);
  const data=await res.json();

  if(data.status==="success"){
    currentStudent=data.data;
    document.getElementById("loginBox").style.display="none";
    loadProfile(currentStudent);
    loadGrades(currentStudent);
    showPage("profilePage");
  }else{
    loginAsTeacher(code);
  }
}

/* =======================
   تسجيل الأستاذ
======================= */
async function loginAsTeacher(email){
  const res=await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"text/plain;charset=utf-8"},
    body:JSON.stringify({action:"get_teacher_info",email})
  });
  const data=await res.json();
  if(data.status!=="success")return;

  currentTeacher=data.data.teacher;
  currentTeacherSubject=currentTeacher["اسم المادة"]||"";
  document.getElementById("loginBox").style.display="none";
  loadTeacherClasses(data.data.classes);
}

/* =======================
   الملف الشخصي
======================= */
function loadProfile(st){
  document.getElementById("profilePage").innerHTML=`
    <button class="logout-btn" onclick="location.reload()">خروج</button>
    <button class="save-btn" onclick="saveChanges('${st["كود الطالب"]}')">حفظ</button>

    <table>
      <tr><th>اسم الطالب</th><td>${st["اسم الطالب"]||""}</td></tr>

      <tr><th>اسم الأم</th>
        <td>
          <input id="اسم الام"
            class="table-input"
            placeholder="اسم الأم الثلاثي"
            value="${st["اسم الام"]||""}"
            oninput="onlyArabicLetters(this)">
        </td>
      </tr>

      <tr><th>العنوان</th>
        <td><input id="العنوان" class="table-input" value="${st["العنوان"]||""}"></td>
      </tr>
    </table>
  `;
}

/* =======================
   حفظ الملف
======================= */
async function saveChanges(code){
  const data={
    "اسم الام":document.getElementById("اسم الام").value,
    "العنوان":document.getElementById("العنوان").value
  };

  await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"text/plain;charset=utf-8"},
    body:JSON.stringify({action:"update",code,data})
  });
  alert("تم الحفظ");
}

/* =======================
   حساب الدرجات (تقريب للأعلى)
======================= */
function toNum(v){
  const n=parseFloat(v);
  return isNaN(n)?0:n;
}
function hasVal(v){
  return v!==""&&v!=null;
}
function calcTerm(a,b){
  if(!hasVal(a)||!hasVal(b))return"";
  return ((toNum(a)+toNum(b))/2).toFixed(2);
}
function calcSaay(t1,mid,t2,fin){
  if(!hasVal(t1)||!hasVal(mid)||!hasVal(t2)||!hasVal(fin))return"";
  const avg=(toNum(t1)+toNum(mid)+toNum(t2)+toNum(fin))/4;
  return Math.ceil(avg);
}
function calcGrade(s){
  if(s<50)return"مكمل";
  if(s>=90)return"ممتاز";
  if(s>=80)return"جيد جداً";
  if(s>=70)return"جيد";
  if(s>=60)return"متوسط";
  return"ضعيف";
}

/* =======================
   درجات الطالب
======================= */
function loadGrades(st){
  document.getElementById("gradesPage").innerHTML=`
    <h3>درجات الطالب</h3>
    <p>السعي: <b>${st["العربي السعي"]||"-"}</b></p>
    <p>التقدير: <b>${st["العربي التقدير"]||"-"}</b></p>
  `;
}

/* =======================
   صفوف الأستاذ
======================= */
function loadTeacherClasses(classes){
  let html="<h3>صفوف الأستاذ</h3>";
  classes.forEach(c=>{
    html+=`<button onclick="openTeacherClass('${c}')">${c}</button>`;
  });
  document.getElementById("teacherClassesPage").innerHTML=html;
  showPage("teacherClassesPage");
}

/* =======================
   جدول درجات الأستاذ
======================= */
async function openTeacherClass(className){
  currentTeacherClassName=className;

  const res=await fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"text/plain;charset=utf-8"},
    body:JSON.stringify({
      action:"get_class_grades",
      subject:currentTeacherSubject,
      className
    })
  });
  const data=await res.json();
  renderTeacherGrades(data.data.students);
}

function renderTeacherGrades(students){
  let html=`<table border="1"><tr>
    <th>الطالب</th><th>شهر1</th><th>شهر2</th><th>نصف</th><th>نهائي</th><th>السعي</th><th>التقدير</th>
  </tr>`;

  students.forEach(st=>{
    html+=`
      <tr>
        <td>${st.name}</td>
        <td><input class="teacher-grade-input" oninput="recalc(this)"></td>
        <td><input class="teacher-grade-input" oninput="recalc(this)"></td>
        <td><input class="teacher-grade-input" oninput="recalc(this)"></td>
        <td><input class="teacher-grade-input" oninput="recalc(this)"></td>
        <td class="teacher-grade-static"></td>
        <td class="teacher-grade-static"></td>
      </tr>`;
  });

  html+="</table>";
  document.getElementById("teacherGradesPage").innerHTML=html;
  showPage("teacherGradesPage");
}

function recalc(inp){
  const tr=inp.closest("tr");
  const v=[...tr.querySelectorAll("input")].map(i=>i.value);
  const saay=calcSaay(v[0],v[2],v[1],v[3]);
  tr.children[5].innerText=saay;
  tr.children[6].innerText=calcGrade(saay);
}
</script>
</body>
</html>